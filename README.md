# Importance Sampling

Given some random variable *X* s.t. *X* ∼ *P*<sub>0</sub>(*X*) and we want to estimate the expectation of some function of X (i.e., *F*(*X*)). A Monte Carlo way is to generate an ensemble of realizations of (*x*<sub>*i*</sub><sup>0</sup>,*f*(*x*<sub>*i*</sub><sup>0</sup>)) for *i* = 1, 2, ..., *N* according to the distribution *P*<sub>0</sub> and the approximate expectation is then given by

$$E\_{P_0}\[F(X)\] = \int_x F(x) P_0(x) dx \approx \frac{1}{N} F(x^0_n)$$

For situations where we have special interests in rare events (which can
be described by a subset *B* of all possible outcomes of *X*). Assume
the *P*(*X*∈*B*) = *γ*<sub>*B*</sub> over some time horizon *T*, the
relative error using Eq 1 is of the order of $1/\sqrt{N \gamma_B}$ and
can be pretty large when *γ*<sub>*B*</sub> is small.

The importance sampling can let one draw more frequently from *B* using
some well-designed, altered pdf *P*<sub>*k*</sub> based on the Eq 2.

$$E\_{P_0}\[F(X)\] = \int_x F(x) P_0(x) dx = \int_x F(x) \frac{P_0(x)}{P_k(x)} P_k(x) dx = E\_{P_k}\[F(X)\frac{P_0(X)}{P_k(X)}\] \sim \frac{1}{N} F(x^k_n) \frac{P_0(x^k_n)}{P_k(x^k_n)}$$

In our context, importance sampling has to be performed at the level of
trajectories. Trajectories generated by the model are distributed
according to some unknown pdf
*P*<sub>0</sub>({*X*(*t*)}<sub>0 ≤ *t* ≤ *T*</sub>={*x*(*t*)}<sub>0 ≤ *t* ≤ *T*</sub>).
Suppose given the model trajectory, we can evaluate some quantity of
interest as given by *A*(*x*(*t*)). If we want to estimate the return
period/probability of the time integral of *A*(*x*(*t*)) dropping below
some threshold *a*, this can be transformed to an expectation estimation
problem as given by the Eq 3, where **1**<sub>*b*</sub>(*x*) equals 1 if
*x* \< *b* and 0 otherwise. In our case, *A*(*x*<sub>*t*</sub>) can the
precipitation at time step *t* and this can be used to estimate
probability of total DJF precipitation dropping below some level *b*.

$$ P(\int_0^T A(x(t)) dt < b) = \int_x \textbf{1}_b(\int_0^T A(x(t))dt)P_0(\{x(t)\}_{0\leq t \leq T})dx = E[\textbf{1}_b(\int_0^T A(x(t))dt)] $$

Suppose from Eq 2 and 3 we can estimate the probability of total DJF
precipitation being smaller than *b* as denoted by *γ*<sub>*b*</sub>,
then the return period is simply *r*(*b*) = 1/*γ*<sub>*b*</sub> years.

# Importance Sampling + Monte Carlo

Suppose the simulation horizon is *T*<sub>*a*</sub> (e.g., DJF or
∼<!-- -->90 days in our case) and it can be divided into multiple
sub-intervals (i.e., *T*<sub>*a*</sub> = *m* ⋅ *τ*). A total of *N*
trajectories are initiated using independent initial conditions and the
same set of climatological boundary conditions is used. A workflow to
implement the algorithm is given below for *i* = 1, 2, ..., *m*

1\. Iterate each trajectory from time *t*<sub>*i* − 1</sub> = (*i*−1)*τ*
to time *t*<sub>*i*</sub> = *iτ*,

2\. At time *t*<sub>*i*</sub>, stop the simulation and estimate the
weight associated with each trajectory *n* as given by

$$W^i_n = \frac{e^k\int^{t_i}\_{t\_{i-1}}A(X_n(t))dt}{R_i}$$

where

$$R_i = \frac{1}{N}e^k\int^{t_i}\_{t\_{i-1}}A(X_n(t))dt,$$

3\. Randomly sample *N* new trajectories (with replacement) according to
the probability mass function $P(x=n) \propto W_n^i$,

4\. Add small random perturbations to the states of the $N$ new
trajectories at time $t_i$,

5\. Increment $i$ by 1 and repeat 1-5.

Note that I used the above workflow in my demo (without the perturbation
step since I used a stochastic toy model), which is slightly different
from the orign
